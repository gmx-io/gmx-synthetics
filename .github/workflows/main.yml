name: CI
on:
  pull_request:
    types: [opened, synchronize, edited, ready_for_review]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      
      - name: Install packages
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - run: yarn --ignore-scripts
        shell: bash
      
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
      
      - name: Run Hardhat Tests
        run: yarn hardhat test
        shell: bash
        
      - name: Run Forge Tests
        run: forge test -vv
        shell: bash

  gas-snapshot:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
      
      - name: Generate Gas Snapshot
        run: forge snapshot
        shell: bash
      
      - name: Check Gas Regression
        run: |
          # Check if swap() gas usage exceeds baseline by more than 5%
          # First generate current gas report
          forge test --match-contract SwapHandlerTests --gas-report > current_gas_report.txt
          
          # Extract swap function gas usage
          SWAP_GAS=$(grep -A 20 "Gas Report" current_gas_report.txt | grep "swap" | head -n 1 | awk '{print $2}')
          
          # Check if baseline snapshot exists
          if [ -f .gas-snapshot ]; then
            # If baseline exists, extract swap-related test gas usage
            BASELINE_GAS=$(cat .gas-snapshot | grep -E "test_constantProductApproximation|test_nonNegativeReserves|test_quoteValueConservation" | awk '{print $NF}' | head -n 1)
          else
            echo "Error: .gas-snapshot file not found"
            exit 1
          fi
          
          if [ -z "$SWAP_GAS" ] || [ -z "$BASELINE_GAS" ]; then
            echo "Error: Could not find swap() gas data"
            exit 1
          fi
          
          # Calculate 5% threshold
          THRESHOLD=$(echo "$BASELINE_GAS * 1.05" | bc | awk -F. '{print $1}')
          
          echo "Current swap() gas: $SWAP_GAS"
          echo "Baseline swap() gas: $BASELINE_GAS"
          echo "Threshold (5% increase): $THRESHOLD"
          
          if [ "$SWAP_GAS" -gt "$THRESHOLD" ]; then
            echo "ERROR: swap() gas usage exceeds baseline by more than 5%"
            exit 1
          else
            echo "OK: swap() gas usage is within acceptable range"
          fi
